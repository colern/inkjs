!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.InkCanvas=i()}(this,function(){"use strict";function t(t,i,o,e){this.x=t,this.y=i,this.time=e||(new Date).getTime(),this.pressure=o||.5}function i(t,i,o,e){this.startPoint=t,this.control1=i,this.control2=o,this.endPoint=e}function o(t,i,o){var e,n,s,r=null,a=0;o||(o={});var h=function(){a=!1===o.leading?0:Date.now(),r=null,s=t.apply(e,n),r||(e=n=null)};return function(){var l=Date.now();a||!1!==o.leading||(a=l);var u=i-(l-a);return e=this,n=arguments,u<=0||u>i?(r&&(clearTimeout(r),r=null),a=l,s=t.apply(e,n),r||(e=n=null)):r||!1===o.trailing||(r=setTimeout(h,u)),s}}function e(t,i){this.p1=t,this.p2=i,null!=t&&null!=i&&(this.top=Math.min(t.y,i.y),this.bottom=Math.max(t.y,i.y),this.left=Math.min(t.x,i.x),this.right=Math.max(t.x,i.x))}function n(t,i){}function s(t,i){this.data=[],this._smoothData=[],this.color=i,this.id=t,this.length=0,this.hide=!1,this.radiu=1.5,this.bbox=new e(null,null)}function r(t,i){window.PointerEvent||alert("unsupport pointer event api");var e=this,n=i||{};this.velocityFilterWeight=n.velocityFilterWeight||.7,this.radiu=n.radiu||1.5,this.throttle="throttle"in n?n.throttle:16,this.minDistance=n.minDistance||2,this.maxID=0,this.smoothGroup=[],this.smoothLength=5,this.throttle?this._strokeMoveUpdate=o(r.prototype._strokeUpdate,this.throttle):this._strokeMoveUpdate=r.prototype._strokeUpdate,this.dotSize=n.dotSize||function(){return this.radiu},this.penColor=n.penColor||"black",this.state=n.state||"pen",this.backgroundColor=n.backgroundColor||"rgba(0,0,0,0)",this.onBegin=n.onBegin,this.onEnd=n.onEnd,this._lastPoint=null,this._selectIds=[],this._canvas=t,this._ctx=t.getContext("2d"),this.clear(),this._handlePointerDown=function(t){1==t.which?(e._mouseButtonDown=!0,e._strokeBegin(t)):t.which},this._handlePointerMove=function(t){e._mouseButtonDown&&e._strokeMoveUpdate(t)},this._handlePointerUp=function(t){1===t.which&&e._mouseButtonDown&&(e._mouseButtonDown=!1,e._strokeEnd(t),"select"===e.state&&e.redraw())},this._handlePointerLost=function(t){e._mouseButtonDown&&(e._mouseButtonDown=!1,e._strokeEnd(t))},this.on()}return t.prototype.velocityFrom=function(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):1},t.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.radiu=function(){},i.calculateCurveControlPoints=function(i,o,e){var n=i.x-o.x,s=i.y-o.y,r=o.x-e.x,a=o.y-e.y,h={x:(i.x+o.x)/2,y:(i.y+o.y)/2},l={x:(o.x+e.x)/2,y:(o.y+e.y)/2},u=Math.sqrt(n*n+s*s),d=Math.sqrt(r*r+a*a),c=h.x-l.x,p=h.y-l.y,f=d/(u+d),_={x:l.x+c*f,y:l.y+p*f},v=o.x-_.x,y=o.y-_.y;return{c1:new t(h.x+v,h.y+y),c2:new t(l.x+v,l.y+y)}},i.prototype.length=function(){for(var t=0,i=void 0,o=void 0,e=0;e<=10;e+=1){var n=e/10,s=this._point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),r=this._point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(e>0){var a=s-i,h=r-o;t+=Math.sqrt(a*a+h*h)}i=s,o=r}return t},i.prototype._point=function(t,i,o,e,n){return i*(1-t)*(1-t)*(1-t)+3*o*(1-t)*(1-t)*t+3*e*(1-t)*t*t+n*t*t*t},e.prototype.isInBound=function(t,i){return t>=this.left&&t<=this.right&&i>=this.top&&i<=this.bottom},e.prototype.slopeWith=function(t,i){return Math.abs(this.slope(t,i))<.3},e.prototype.slope=function(t,i){var o=this.p2.x-this.p1.x,e=this.p2.y-this.p1.y;return(t-this.p1.x)/o-(i-this.p1.y)/e},e.prototype.isIntersect=function(t){var i=Math.max(this.left,t.left),o=Math.min(this.right,t.right),e=Math.max(this.top,t.top),n=Math.min(this.bottom,t.bottom);return i-o<0&&e-n<0},n.smooth=function(i,o,e){if(e<=1)return i[0];for(var n=0,s=0,r=0,a=0,h=Math.min(o+e,i.length),l=o;l<h;++l)n+=i[l].x,s+=i[l].y,r+=i[l].pressure,a+=i[l].time;var u=h-o;return new t(n/u,s/u,r/u,a/u)},s.createFragment=function(t,o){var e=t.length-o;if(e>=2){var n=t[o],s=null,r=null,a=null;2==e?(s=t[o],r=t[o+1],a=t[o+1]):3===e?(s=t[o],r=t[o+1],a=t[o+2]):(s=t[o+1],r=t[o+2],a=t[o+3]);var h=i.calculateCurveControlPoints(n,s,r),l=h.c2;h=i.calculateCurveControlPoints(s,r,a);return new i(s,l,h.c1,r)}return null},s.calculateFragmentWidths=function(t,i){var o=t.startPoint,e=t.endPoint,n={start:null,end:null},s=Math.exp(-2*i*(o.pressure-.5)),r=Math.exp(-2*i*(e.pressure-.5));return n.start=2*i/(1+s),n.end=2*i/(1+r),n},s.drawFragment=function(t,i,o,e){var n=e-o,r=Math.floor(i.length());t.beginPath(),0==r&&console.info("000");for(var a=0;a<r;a+=1){var h=a/r,l=h*h,u=l*h,d=1-h,c=d*d,p=c*d,f=p*i.startPoint.x;f+=3*c*h*i.control1.x,f+=3*d*l*i.control2.x,f+=u*i.endPoint.x;var _=p*i.startPoint.y;_+=3*c*h*i.control1.y,_+=3*d*l*i.control2.y,_+=u*i.endPoint.y;var v=o+u*n;v<=.3&&console.info("----"),s.drawPoint(t,f,_,v)}t.closePath(),t.fill()},s.drawPoint=function(t,i,o,e){t.moveTo(i,o),t.arc(i,o,e,0,2*Math.PI,!1)},s.prototype.appendPoint=function(t){0==this.data.length&&(this.bbox.left=t.x,this.bbox.right=t.x,this.bbox.top=t.y,this.bbox.bottom=t.y),this.data.push(t);var i=t.x,o=t.y;this.bbox.right=Math.max(this.bbox.right,i,this.bbox.left),this.bbox.left=Math.min(this.bbox.right,i,this.bbox.left),this.bbox.top=Math.min(this.bbox.top,o,this.bbox.bottom),this.bbox.bottom=Math.max(this.bbox.top,o,this.bbox.bottom),this.length+=1},s.prototype.last=function(){return 0==this.data.length?null:this.data[this.data.length-1]},s.prototype.get=function(t){return this.data[t]},s.prototype.isIn=function(t,i){return this.bbox.isInBound(t,i)},s.prototype.draw=function(t){if(1!=this.hide){var i=t.fillStyle;t.fillStyle=this.color;for(var o=0;o<4;++o){var e=[];0==o&&e.push(this._smoothData[0]),1==o&&(e.push(this._smoothData[0]),e.push(this._smoothData[1])),2==o&&(e.push(this._smoothData[0]),e.push(this._smoothData[1]),e.push(this._smoothData[2])),3==o&&(e.push(this._smoothData[o-3]),e.push(this._smoothData[o-2]),e.push(this._smoothData[o-1]),e.push(this._smoothData[o])),this._drawFrag(t,e,0)}for(var n=0;n<this._smoothData.length;++n)this._drawFrag(t,this._smoothData,n);t.fillStyle=i}},s.prototype._drawFrag=function(t,i,o){var e=s.createFragment(i,o);if(e){var n=s.calculateFragmentWidths(e,this.radiu);n&&s.drawFragment(t,e,n.start,n.end)}},r.prototype.clear=function(){var t=this._ctx,i=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,i.width,i.height),t.fillRect(0,0,i.width,i.height),this._data=[],this._reset(),this._isEmpty=!0},r.prototype.setRadiu=function(t){t>5&&(t=5),t<.01&&(t=1),this.radiu=t||1.5},r.prototype.setState=function(t){this.state=t},r.prototype.fromDataURL=function(t){var i=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=new Image,n=o.ratio||window.devicePixelRatio||1,s=o.width||this._canvas.width/n,r=o.height||this._canvas.height/n;this._reset(),e.src=t,e.onload=function(){i._ctx.drawImage(e,0,0,s,r)},this._isEmpty=!1},r.prototype.toDataURL=function(t){var i;switch(t){case"image/svg+xml":return this._toSVG();default:for(var o=arguments.length,e=Array(o>1?o-1:0),n=1;n<o;n++)e[n-1]=arguments[n];return(i=this._canvas).toDataURL.apply(i,[t].concat(e))}},r.prototype.on=function(){this._mouseButtonDown=!1,this._canvas.addEventListener("pointerdown",this._handlePointerDown),this._canvas.addEventListener("pointermove",this._handlePointerMove),this._canvas.addEventListener("pointerup",this._handlePointerUp),this._canvas.addEventListener("lostpointercapture",this._handlePointerLost)},r.prototype.off=function(){this._canvas.removeEventListener("pointerdown",this._handlePointerDown),this._canvas.removeEventListener("pointermove",this._handlePointerMove),this._canvas.removeEventListener("pointerup",this._handlePointerUp)},r.prototype.isEmpty=function(){return this._isEmpty},r.prototype.hitTest=function(t){for(var i=this._data.length,o=[],n=0;n<i;++n)this._data[n].isIn(t.x,t.y)&&o.push(this._data[n]);for(var s=[],r=0;r<o.length;++r)for(var a=o[r],h=a._smoothData,l=0;l<h.length-1;++l){var u=h[l],d=h[l+1],c=new e(u,d);if(null==this._lastPoint)c.isInBound(t.x,t.y)&&c.slopeWith(t.x,t.y)&&s.push(a);else if(c.isIntersect(new e(this._lastPoint,t))){var p=c.slope(this._lastPoint.x,this._lastPoint.y),f=c.slope(t.x,t.y);(p*f<0||Math.abs(p)<.3||Math.abs(f)<.3)&&s.push(a)}c=null}return this._lastPoint=t,s.length>0?s:null},r.prototype.redraw=function(){this._clearBackground(),this.drawCurves(this._data)},r.prototype.drawCurve=function(t){this._ctx.beginPath(),this._drawCurve(t),this._ctx.closePath()},r.prototype.drawCurves=function(t){this._ctx.beginPath();for(var i=0;i<t.length;++i)this._drawCurve(t[i]);this._ctx.closePath()},r.prototype._strokeBegin=function(t){if("pen"==this.state){this.maxID+=1;var i=new s(this.maxID,this.penColor);i.radiu=this.radiu,this._data.push(i),this._reset()}this._strokeUpdate(t),"function"==typeof this.onBegin&&this.onBegin(t)},r.prototype._strokeUpdate=function(t){var i=this._event2Point(t);switch(this.state){case"pen":this._drawAddedPoint(i);break;case"eraser":var o=this.hitTest(i);if(null!=o){for(var e=0;e<o.length;++e)o[e].hide=!0;this.redraw()}break;case"select":0==this._selectIds.length&&(console.info("ddd"),this._drawRing(i));break;default:this.hitTest(i)}},r.prototype._strokeEnd=function(t){if("pen"==this.state){var i=this.points.length>2,o=this.points[0];!i&&o&&this._drawDot(o);var e=this._event2Point(t);e.pressure=.005,this._drawAddedPoint(e),this._drawLastPoints()}"function"==typeof this.onEnd&&this.onEnd(t)},r.prototype._clearBackground=function(){var t=this._ctx,i=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,i.width,i.height),t.fillRect(0,0,i.width,i.height)},r.prototype._drawCurve=function(t){t.draw(this._ctx)},r.prototype._addSmoothPoint=function(t){this.smoothGroup.push(t),this._data[this._data.length-1]._smoothData.push(t)},r.prototype._smoothTo=function(t){var i=this.points,o=i.length,e=this._data[this._data.length-1];if(t){if(o>0){var s=i[o-1];if(t.equals(s))return}if(e.appendPoint(t),i.push(t),o<2)return void(0==this.smoothGroup.length&&this._addSmoothPoint(i[0]));var r=Math.max(o-5,0),a=n.smooth(i,r,r>0?5:3);this._addSmoothPoint(a)}else if(o<2)this._addSmoothPoint(i[o-1]);else if(o>2){var h=n.smooth(i,o-3,3);this._addSmoothPoint(h),this._addSmoothPoint(i[o-1])}},r.prototype._event2Point=function(t){var i=t.clientX,o=t.clientY;return t.pressure&&(this.pressure=t.pressure),this._createPoint(i,o,this.pressure)},r.prototype._drawAddedPoint=function(t){var i=this._addPoint(t);i?this._calculateWidthAndDraw(i):0==this.points.length&&this._drawDot(t)},r.prototype._calculateWidthAndDraw=function(t){var i=s.calculateFragmentWidths(t,this.radiu);i?s.drawFragment(this._ctx,t,i.start,i.end):console.info("width")},r.prototype._drawLastPoints=function(){var t=this._addPoint();t&&(this._calculateWidthAndDraw(t),this._drawEndCurve())},r.prototype._drawEndCurve=function(){var t=this._caculateCurve(this.smoothGroup);if(t){this._calculateWidthAndDraw(t);var i=this.smoothGroup[this.smoothGroup.length-1];t.endPoint.equals(i)||(i.pressure=0,this.smoothGroup.push(i),this._drawEndCurve())}else console.info("null")},r.prototype._reset=function(){this.points=[],this.smoothGroup=[],this._lastPoint=null,this._lastVelocity=0,this._lastWidth=this.radiu,this._ctx.fillStyle=this.penColor},r.prototype._createPoint=function(i,o,e,n){var s=this._canvas.getBoundingClientRect();return new t(i-s.left,o-s.top,e,n||(new Date).getTime())},r.prototype._caculateCurve=function(t){if(t.length>2){3===t.length&&t.unshift(t[0]);var i=s.createFragment(t,0);return t.shift(),i}return null},r.prototype._addPoint=function(t){return this._smoothTo(t),this._caculateCurve(this.smoothGroup)},r.prototype._drawPoint=function(t,i,o){s.drawPoint(this._ctx,t,i,o),this._isEmpty=!1},r.prototype._drawDot=function(t){var i=this._ctx,o="function"==typeof this.dotSize?this.dotSize():this.dotSize;i.beginPath(),this._drawPoint(t.x,t.y,o),i.closePath(),i.fill()},r.prototype._drawRing=function(t){var i=this._ctx,o=i.fillStyle;i.fillStyle="black",i.beginPath(),i.arc(t.x,t.y,3,0,2*Math.PI),i.closePath(),i.stroke(),i.fillStyle=o},r.prototype._fromData=function(t,i,o){for(var e=0;e<t.length;e+=1){var n=t[e];if(n.length>1)for(var r=0;r<n.length;r+=1){var a=n.get(r),h=n.color;if(0===r)this._reset(),this._addPoint(a);else if(r!==n.length-1){var l=this._addPoint(a);if(l){var u=s.calculateFragmentWidths(l,this.radiu);u&&i(l,u,h)}}}else{this._reset();o(n.get(0))}}},r.prototype._toSVG=function(){var t=this,i=this._data,o=this._canvas,e=Math.max(window.devicePixelRatio||1,1),n=o.width/e,s=o.height/e,r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS(null,"width",o.width),r.setAttributeNS(null,"height",o.height),this._fromData(i,function(t,i,o){var e=document.createElement("path");if(!(isNaN(t.control1.x)||isNaN(t.control1.y)||isNaN(t.control2.x)||isNaN(t.control2.y))){var n="M "+t.startPoint.x.toFixed(3)+","+t.startPoint.y.toFixed(3)+" C "+t.control1.x.toFixed(3)+","+t.control1.y.toFixed(3)+" "+t.control2.x.toFixed(3)+","+t.control2.y.toFixed(3)+" "+t.endPoint.x.toFixed(3)+","+t.endPoint.y.toFixed(3);e.setAttribute("d",n),e.setAttribute("stroke-width",(2.25*i.end).toFixed(3)),e.setAttribute("stroke",o),e.setAttribute("fill","none"),e.setAttribute("stroke-linecap","round"),r.appendChild(e)}},function(i){var o=document.createElement("circle"),e="function"==typeof t.dotSize?t.dotSize():t.dotSize;o.setAttribute("r",e),o.setAttribute("cx",i.x),o.setAttribute("cy",i.y),o.setAttribute("fill",i.color),r.appendChild(o)});var a='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 '+n+" "+s+'" width="'+n+'" height="'+s+'">',h=r.innerHTML;if(void 0===h){var l=document.createElement("dummy"),u=r.childNodes;l.innerHTML="";for(var d=0;d<u.length;d+=1)l.appendChild(u[d].cloneNode(!0));h=l.innerHTML}var c=a+h+"</svg>";return"data:image/svg+xml;base64,"+btoa(c)},r.prototype.fromData=function(t){var i=this;this.clear(),this._fromData(t,function(t,o){return s.drawFragment(i._ctx,t,o.start,o.end)},function(t){return i._drawDot(t)}),this._data=t},r.prototype.toData=function(){return this._data},r});
