!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):t.InkCanvas=o()}(this,function(){"use strict";function t(t,o,i,e){this.x=t,this.y=o,this.time=e||(new Date).getTime(),this.pressure=i||.5}function o(t,o,i,e){this.startPoint=t,this.control1=o,this.control2=i,this.endPoint=e}function i(t,o,i){var e,n,s,r=null,a=0;i||(i={});var h=function(){a=!1===i.leading?0:Date.now(),r=null,s=t.apply(e,n),r||(e=n=null)};return function(){var l=Date.now();a||!1!==i.leading||(a=l);var u=o-(l-a);return e=this,n=arguments,u<=0||u>o?(r&&(clearTimeout(r),r=null),a=l,s=t.apply(e,n),r||(e=n=null)):r||!1===i.trailing||(r=setTimeout(h,u)),s}}function e(t,o){this.p1=t,this.p2=o,null!=t&&null!=o&&(this.top=Math.min(t.y,o.y),this.bottom=Math.max(t.y,o.y),this.left=Math.min(t.x,o.x),this.right=Math.max(t.x,o.x))}function n(t,o){}function s(t,o){this.data=[],this._smoothData=[],this.color=o,this.id=t,this.length=0,this.hide=!1,this.radiu=1.5,this.bbox=new e(null,null)}function r(t,o){window.PointerEvent||alert("unsupport pointer event api");var n=this,s=o||{};this.velocityFilterWeight=s.velocityFilterWeight||.7,this.radiu=s.radiu||1.5,this.throttle="throttle"in s?s.throttle:16,this.minDistance=s.minDistance||2,this.maxID=0,this.smoothGroup=[],this.smoothLength=5,this.throttle?(this._strokeMoveUpdate=i(r.prototype._strokeUpdate,this.throttle),this._selectMoveUpdate=i(r.prototype._mouseMove,this.throttle)):(this._strokeMoveUpdate=r.prototype._strokeUpdate,this._selectMoveUpdate=r.prototype._mouseMove),this.dotSize=s.dotSize||function(){return this.radiu},this.penColor=s.penColor||"black",this.state=s.state||"pen",this.backgroundColor=s.backgroundColor||"rgba(0,0,0,0)",this.onBegin=s.onBegin,this.onEnd=s.onEnd,this._lastPoint=null,this._selectCurves=[],this._bbox=new e(null,null),this._canvas=t,this._ctx=t.getContext("2d"),this.clear(),this._handlePointerDown=function(t){1==t.which?(n._mouseButtonDown=!0,"select"===n.state&&(n.smoothGroup=[],n._bbox.clear()),n._strokeBegin(t)):t.which},this._handlePointerMove=function(t){n._mouseButtonDown?n._strokeMoveUpdate(t):n._selectMoveUpdate(t)},this._handlePointerUp=function(t){1===t.which&&n._mouseButtonDown&&(n._mouseButtonDown=!1,n._strokeEnd(t),"select"===n.state&&n.redraw())},this._handlePointerLost=function(t){n._mouseButtonDown&&(n._mouseButtonDown=!1,n._strokeEnd(t))},this.on()}function a(t,o){null!=o.left&&(t.strokeStyle="gray",t.beginPath(),t.moveTo(o.left,o.top),t.lineTo(o.right,o.top),t.lineTo(o.right,o.bottom),t.lineTo(o.left,o.bottom),t.lineTo(o.left,o.top),t.stroke(),t.closePath())}return t.prototype.velocityFrom=function(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):1},t.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.radiu=function(){},t.prototype.isInArea=function(t){for(var o=2*Math.PI,i=[],e=0;e<t.length;++e){var n=t[e],s=n.x-this.x,r=n.y-this.y,a=Math.atan2(r,s);a<0?i.push(o+a):i.push(a)}for(var h=0,l=0;l<i.length;++l){var u=i[l],p=l+1;p>=i.length&&(p=0);var c=i[p],d=c-u;l+1>=i.length&&d<-Math.PI&&(d=2*Math.PI+d),h+=d}return Math.abs(h)<.01},o.calculateCurveControlPoints=function(o,i,e){var n=o.x-i.x,s=o.y-i.y,r=i.x-e.x,a=i.y-e.y,h={x:(o.x+i.x)/2,y:(o.y+i.y)/2},l={x:(i.x+e.x)/2,y:(i.y+e.y)/2},u=Math.sqrt(n*n+s*s),p=Math.sqrt(r*r+a*a),c=h.x-l.x,d=h.y-l.y,f=p/(u+p),v={x:l.x+c*f,y:l.y+d*f},_=i.x-v.x,y=i.y-v.y;return{c1:new t(h.x+_,h.y+y),c2:new t(l.x+_,l.y+y)}},o.prototype.length=function(){for(var t=0,o=void 0,i=void 0,e=0;e<=10;e+=1){var n=e/10,s=this._point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),r=this._point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(e>0){var a=s-o,h=r-i;t+=Math.sqrt(a*a+h*h)}o=s,i=r}return t},o.prototype._point=function(t,o,i,e,n){return o*(1-t)*(1-t)*(1-t)+3*i*(1-t)*(1-t)*t+3*e*(1-t)*t*t+n*t*t*t},e.prototype.clear=function(){this.p1=null,this.p2=null,this.top=null,this.bottom=null,this.left=null,this.right=null},e.prototype.isInBound=function(t,o){return t>=this.left&&t<=this.right&&o>=this.top&&o<=this.bottom},e.prototype.isOnVertical=function(t,o){return Math.abs(t-this.left)<=2||Math.abs(t-this.right)<=2},e.prototype.isOnHorizon=function(t,o){return Math.abs(o-this.top)<=2||Math.abs(o-this.bottom)<=2},e.prototype.slopeWith=function(t,o){return Math.abs(this.slope(t,o))<.3},e.prototype.slope=function(t,o){var i=this.p2.x-this.p1.x,e=this.p2.y-this.p1.y;return(t-this.p1.x)/i-(o-this.p1.y)/e},e.prototype.isIntersect=function(t){var o=Math.max(this.left,t.left),i=Math.min(this.right,t.right),e=Math.max(this.top,t.top),n=Math.min(this.bottom,t.bottom);return o-i<0&&e-n<0},e.prototype.merge=function(t){null==this.left&&(this.p1=t.p1,this.p2=t.p2,this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom),this.top=Math.min(this.top,t.top),this.bottom=Math.max(this.bottom,t.bottom),this.left=Math.min(this.left,t.left),this.right=Math.max(this.right,t.right)},n.smooth=function(o,i,e){if(e<=1)return o[0];for(var n=0,s=0,r=0,a=0,h=Math.min(i+e,o.length),l=i;l<h;++l)n+=o[l].x,s+=o[l].y,r+=o[l].pressure,a+=o[l].time;var u=h-i;return new t(n/u,s/u,r/u,a/u)},s.createFragment=function(t,i){var e=t.length-i;if(e>=2){var n=t[i],s=null,r=null,a=null;2==e?(s=t[i],r=t[i+1],a=t[i+1]):3===e?(s=t[i],r=t[i+1],a=t[i+2]):(s=t[i+1],r=t[i+2],a=t[i+3]);var h=o.calculateCurveControlPoints(n,s,r),l=h.c2;h=o.calculateCurveControlPoints(s,r,a);return new o(s,l,h.c1,r)}return null},s.calculateFragmentWidths=function(t,o){var i=t.startPoint,e=t.endPoint,n={start:null,end:null},s=Math.exp(-2*o*(i.pressure-.5)),r=Math.exp(-2*o*(e.pressure-.5));return n.start=2*o/(1+s),n.end=2*o/(1+r),n},s.drawFragment=function(t,o,i,e){var n=e-i,r=Math.floor(o.length());t.beginPath();for(var a=0;a<r;a+=1){var h=a/r,l=h*h,u=l*h,p=1-h,c=p*p,d=c*p,f=d*o.startPoint.x;f+=3*c*h*o.control1.x,f+=3*p*l*o.control2.x,f+=u*o.endPoint.x;var v=d*o.startPoint.y;v+=3*c*h*o.control1.y,v+=3*p*l*o.control2.y,v+=u*o.endPoint.y;var _=i+u*n;_<=.3&&console.info("----"),s.drawPoint(t,f,v,_)}t.closePath(),t.fill()},s.drawPoint=function(t,o,i,e){t.moveTo(o,i),t.arc(o,i,e,0,2*Math.PI,!1)},s.drawDot=function(t,o,i,e){t.beginPath(),s.drawPoint(t,o,i,e),t.closePath(),t.fill()},s.appendPoint=function(t,o,i){null==o.left&&(o.left=i.x,o.right=i.x,o.top=i.y,o.bottom=i.y),t.push(i);var e=i.x,n=i.y;o.right=Math.max(o.right,e,o.left),o.left=Math.min(o.right,e,o.left),o.top=Math.min(o.top,n,o.bottom),o.bottom=Math.max(o.top,n,o.bottom)},s.prototype.addPoint=function(t){s.appendPoint(this.data,this.bbox,t),this.length+=1},s.prototype.last=function(){return 0==this.data.length?null:this.data[this.data.length-1]},s.prototype.get=function(t){return this.data[t]},s.prototype.isIn=function(t,o){return this.bbox.isInBound(t,o)},s.prototype.draw=function(t){if(1!=this.hide){var o=t.fillStyle;t.fillStyle=this.color;for(var i=0;i<4;++i){for(var e=[],n=0;n<=i;++n){var s=n;s>=this._smoothData.length&&(s=this._smoothData.length-1),e.push(this._smoothData[s])}this._drawFrag(t,e,0)}for(var r=0;r<this._smoothData.length;++r)this._drawFrag(t,this._smoothData,r);t.fillStyle=o}},s.prototype._drawFrag=function(t,o,i){if(o.length<2)s.drawDot(t,o[0].x,o[0].y,this.radiu);else{var e=s.createFragment(o,i);if(e){var n=s.calculateFragmentWidths(e,this.radiu);n&&s.drawFragment(t,e,n.start,n.end)}}},r.prototype.clear=function(){var t=this._ctx,o=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,o.width,o.height),t.fillRect(0,0,o.width,o.height),this._data=[],this._reset(),this._isEmpty=!0},r.prototype.setRadiu=function(t){t>5&&(t=5),t<.01&&(t=1),this.radiu=t||1.5},r.prototype.setState=function(t){this.state=t},r.prototype.fromDataURL=function(t){var o=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=new Image,n=i.ratio||window.devicePixelRatio||1,s=i.width||this._canvas.width/n,r=i.height||this._canvas.height/n;this._reset(),e.src=t,e.onload=function(){o._ctx.drawImage(e,0,0,s,r)},this._isEmpty=!1},r.prototype.toDataURL=function(t){var o;switch(t){case"image/svg+xml":return this._toSVG();default:for(var i=arguments.length,e=Array(i>1?i-1:0),n=1;n<i;n++)e[n-1]=arguments[n];return(o=this._canvas).toDataURL.apply(o,[t].concat(e))}},r.prototype.on=function(){this._mouseButtonDown=!1,this._canvas.addEventListener("pointerdown",this._handlePointerDown),this._canvas.addEventListener("pointermove",this._handlePointerMove),this._canvas.addEventListener("pointerup",this._handlePointerUp),this._canvas.addEventListener("lostpointercapture",this._handlePointerLost)},r.prototype.off=function(){this._canvas.removeEventListener("pointerdown",this._handlePointerDown),this._canvas.removeEventListener("pointermove",this._handlePointerMove),this._canvas.removeEventListener("pointerup",this._handlePointerUp)},r.prototype.isEmpty=function(){return this._isEmpty},r.prototype.hitTest=function(t){for(var o=this._data.length,i=[],n=0;n<o;++n)this._data[n].isIn(t.x,t.y)&&i.push(this._data[n]);for(var s=[],r=0;r<i.length;++r)for(var a=i[r],h=a._smoothData,l=0;l<h.length-1;++l){var u=h[l],p=h[l+1],c=new e(u,p);if(null==this._lastPoint)c.isInBound(t.x,t.y)&&c.slopeWith(t.x,t.y)&&s.push(a);else if(c.isIntersect(new e(this._lastPoint,t))){var d=c.slope(this._lastPoint.x,this._lastPoint.y),f=c.slope(t.x,t.y);(d*f<0||Math.abs(d)<.3||Math.abs(f)<.3)&&s.push(a)}c=null}return this._lastPoint=t,s.length>0?s:null},r.prototype.redraw=function(){this._clearBackground(),this.drawCurves(this._data),a(this._ctx,this._bbox)},r.prototype.drawCurve=function(t){this._ctx.beginPath(),this._drawCurve(t),this._ctx.closePath()},r.prototype.drawCurves=function(t){this._ctx.beginPath();for(var o=0;o<t.length;++o)this._drawCurve(t[o]);this._ctx.closePath()},r.prototype._strokeBegin=function(t){if("pen"==this.state){this.maxID+=1;var o=new s(this.maxID,this.penColor);o.radiu=this.radiu,this._data.push(o),this._reset()}this._strokeUpdate(t),"function"==typeof this.onBegin&&this.onBegin(t)},r.prototype._strokeEnd=function(t){switch(this.state){case"pen":var o=this.points.length>2,i=this.points[0];!o&&i&&this._drawDot(i);var n=this._event2Point(t);n.pressure=.005,this._drawAddedPoint(n),this._drawLastPoints();break;case"select":for(var s=this._data,r=[],a=0;a<s.length;++a){var h=s[a];if(this._bbox.isIntersect(h.bbox)){for(var l=[],u=0;u<h.length;++u){var p=h._smoothData[u];this._bbox.isInBound(p.x,p.y)&&l.push(p)}l.length>0&&r.push({curve:h,points:l})}}for(var c=new e(null,null),d=0;d<r.length;++d)for(var f=0;f<r[d].points.length;++f){var v=r[d].points[f];if(v.isInArea(this.smoothGroup)){c.merge(r[d].curve.bbox);break}}this._bbox=c}"function"==typeof this.onEnd&&this.onEnd(t)},r.prototype._strokeUpdate=function(t){var o=this._event2Point(t);switch(this.state){case"pen":this._drawAddedPoint(o);break;case"eraser":var i=this.hitTest(o);if(null!=i){for(var e=0;e<i.length;++e)i[e].hide=!0;this.redraw()}break;case"select":if(0==this._selectCurves.length){this._drawRing(o);var n=this.smoothGroup;if(n.length&&n[n.length-1].equals(o))break;s.appendPoint(this.smoothGroup,this._bbox,o)}break;default:this.hitTest(o)}},r.prototype._mouseMove=function(t){if("select"===this.state){var o=this._event2Point(t),i=this._canvas;this._bbox.isInBound(o.x,o.y)?this._bbox.isOnVertical(o.x,o.y)?i.style.cursor="e-resize":this._bbox.isOnHorizon(o.x,o.y)?i.style.cursor="n-resize":i.style.cursor="move":i.style.cursor="auto"}},r.prototype._clearBackground=function(){var t=this._ctx,o=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,o.width,o.height),t.fillRect(0,0,o.width,o.height)},r.prototype._drawCurve=function(t){t.draw(this._ctx)},r.prototype._addSmoothPoint=function(t){this.smoothGroup.push(t),this._data[this._data.length-1]._smoothData.push(t)},r.prototype._smoothTo=function(t){var o=this.points,i=o.length,e=this._data[this._data.length-1];if(t){if(i>0){var s=o[i-1];if(t.equals(s))return}if(e.addPoint(t),o.push(t),i<2)return void(0==this.smoothGroup.length&&this._addSmoothPoint(o[0]));var r=Math.max(i-5,0),a=n.smooth(o,r,r>0?5:3);this._addSmoothPoint(a)}else if(i<2)this._addSmoothPoint(o[i-1]);else if(i>2){var h=n.smooth(o,i-3,3);this._addSmoothPoint(h),this._addSmoothPoint(o[i-1])}},r.prototype._event2Point=function(t){var o=t.clientX,i=t.clientY;return t.pressure&&(this.pressure=t.pressure),this._createPoint(o,i,this.pressure)},r.prototype._drawAddedPoint=function(t){var o=this._addPoint(t);o?this._calculateWidthAndDraw(o):0==this.points.length&&this._drawDot(t)},r.prototype._calculateWidthAndDraw=function(t){var o=s.calculateFragmentWidths(t,this.radiu);o?s.drawFragment(this._ctx,t,o.start,o.end):console.info("width")},r.prototype._drawLastPoints=function(){var t=this._addPoint();t&&(this._calculateWidthAndDraw(t),this._drawEndCurve())},r.prototype._drawEndCurve=function(){var t=this._caculateCurve(this.smoothGroup);if(t){this._calculateWidthAndDraw(t);var o=this.smoothGroup[this.smoothGroup.length-1];t.endPoint.equals(o)||(o.pressure=.005,this.smoothGroup.push(o),this._drawEndCurve())}else console.info("null")},r.prototype._reset=function(){this.points=[],this.smoothGroup=[],this._lastPoint=null,this._lastVelocity=0,this._lastWidth=this.radiu,this._ctx.fillStyle=this.penColor},r.prototype._createPoint=function(o,i,e,n){var s=this._canvas.getBoundingClientRect();return new t(o-s.left,i-s.top,e,n||(new Date).getTime())},r.prototype._caculateCurve=function(t){if(t.length>2){3===t.length&&t.unshift(t[0]);var o=s.createFragment(t,0);return t.shift(),o}return null},r.prototype._addPoint=function(t){return this._smoothTo(t),this._caculateCurve(this.smoothGroup)},r.prototype._drawDot=function(t){var o=this._ctx,i="function"==typeof this.dotSize?this.dotSize():this.dotSize;this._isEmpty=!1,s.drawDot(o,t.x,t.y,i)},r.prototype._drawRing=function(t){var o=this._ctx,i=o.fillStyle;o.fillStyle="black",o.beginPath(),o.arc(t.x,t.y,3,0,2*Math.PI),o.closePath(),o.stroke(),o.fillStyle=i},r.prototype._fromData=function(t,o,i){for(var e=0;e<t.length;e+=1){var n=t[e];if(n.length>1)for(var r=0;r<n.length;r+=1){var a=n.get(r),h=n.color;if(0===r)this._reset(),this._addPoint(a);else if(r!==n.length-1){var l=this._addPoint(a);if(l){var u=s.calculateFragmentWidths(l,this.radiu);u&&o(l,u,h)}}}else{this._reset();i(n.get(0))}}},r.prototype._toSVG=function(){var t=this,o=this._data,i=this._canvas,e=Math.max(window.devicePixelRatio||1,1),n=i.width/e,s=i.height/e,r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS(null,"width",i.width),r.setAttributeNS(null,"height",i.height),this._fromData(o,function(t,o,i){var e=document.createElement("path");if(!(isNaN(t.control1.x)||isNaN(t.control1.y)||isNaN(t.control2.x)||isNaN(t.control2.y))){var n="M "+t.startPoint.x.toFixed(3)+","+t.startPoint.y.toFixed(3)+" C "+t.control1.x.toFixed(3)+","+t.control1.y.toFixed(3)+" "+t.control2.x.toFixed(3)+","+t.control2.y.toFixed(3)+" "+t.endPoint.x.toFixed(3)+","+t.endPoint.y.toFixed(3);e.setAttribute("d",n),e.setAttribute("stroke-width",(2.25*o.end).toFixed(3)),e.setAttribute("stroke",i),e.setAttribute("fill","none"),e.setAttribute("stroke-linecap","round"),r.appendChild(e)}},function(o){var i=document.createElement("circle"),e="function"==typeof t.dotSize?t.dotSize():t.dotSize;i.setAttribute("r",e),i.setAttribute("cx",o.x),i.setAttribute("cy",o.y),i.setAttribute("fill",o.color),r.appendChild(i)});var a='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 '+n+" "+s+'" width="'+n+'" height="'+s+'">',h=r.innerHTML;if(void 0===h){var l=document.createElement("dummy"),u=r.childNodes;l.innerHTML="";for(var p=0;p<u.length;p+=1)l.appendChild(u[p].cloneNode(!0));h=l.innerHTML}var c=a+h+"</svg>";return"data:image/svg+xml;base64,"+btoa(c)},r.prototype.fromData=function(t){var o=this;this.clear(),this._fromData(t,function(t,i){return s.drawFragment(o._ctx,t,i.start,i.end)},function(t){return o._drawDot(t)}),this._data=t},r.prototype.toData=function(){return this._data},r});
