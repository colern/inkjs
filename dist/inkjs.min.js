!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.InkCanvas=e()}(this,function(){"use strict";function t(t,e,i,o){this.x=t,this.y=e,this.time=o||(new Date).getTime(),this.pressure=i||.5}function e(t,e,i,o){this.startPoint=t,this.control1=e,this.control2=i,this.endPoint=o}function i(t,e,i){var o,n,s,r=null,h=0;i||(i={});var a=function(){h=!1===i.leading?0:Date.now(),r=null,s=t.apply(o,n),r||(o=n=null)};return function(){var l=Date.now();h||!1!==i.leading||(h=l);var u=e-(l-h);return o=this,n=arguments,u<=0||u>e?(r&&(clearTimeout(r),r=null),h=l,s=t.apply(o,n),r||(o=n=null)):r||!1===i.trailing||(r=setTimeout(a,u)),s}}function o(t,e){this.p1=t,this.p2=e,null!=t&&null!=e&&(this.top=Math.min(t.y,e.y),this.bottom=Math.max(t.y,e.y),this.left=Math.min(t.x,e.x),this.right=Math.max(t.x,e.x))}function n(t,e){}function s(t,e){this.data=[],this._smoothData=[],this.color=e,this.id=t,this.length=0,this.hide=!1,this.radiu=1.5,this.bbox=new o(null,null)}function r(t,e){window.PointerEvent||alert("unsupport pointer event api");var n=this,s=e||{};this.velocityFilterWeight=s.velocityFilterWeight||.7,this.radiu=s.radiu||1.5,this.throttle="throttle"in s?s.throttle:16,this.minDistance=s.minDistance||2,this.maxID=0,this.smoothGroup=[],this.smoothLength=5,this.throttle?(this._strokeMoveUpdate=i(r.prototype._strokeUpdate,this.throttle),this._selectMoveUpdate=i(r.prototype._mouseMove,this.throttle)):(this._strokeMoveUpdate=r.prototype._strokeUpdate,this._selectMoveUpdate=r.prototype._mouseMove),this.dotSize=s.dotSize||function(){return this.radiu},this.penColor=s.penColor||"black",this.state=s.state||"pen",this.backgroundColor=s.backgroundColor||"rgba(0,0,0,0)",this.onBegin=s.onBegin,this.onEnd=s.onEnd,this._lastPoint=null,this._selectCurves=[],this._selectState=null,this._startMovePt=null,this._bbox=new o(null,null),this._canvas=t,this._ctx=t.getContext("2d"),this.clear(),this._handlePointerDown=function(t){1==t.which?(n._mouseButtonDown=!0,"select"===n.state&&(n.smoothGroup=[]),n._strokeBegin(t)):t.which},this._handlePointerMove=function(t){n._mouseButtonDown?n._strokeMoveUpdate(t):n._selectMoveUpdate(t)},this._handlePointerUp=function(t){1===t.which&&n._mouseButtonDown&&(n._mouseButtonDown=!1,n._strokeEnd(t),"select"===n.state&&n.redraw())},this._handlePointerLost=function(t){n._mouseButtonDown&&(n._mouseButtonDown=!1,n._strokeEnd(t))},this.on()}function h(t,e){null!=e.left&&(t.strokeStyle="gray",t.beginPath(),t.moveTo(e.left,e.top),t.lineTo(e.right,e.top),t.lineTo(e.right,e.bottom),t.lineTo(e.left,e.bottom),t.lineTo(e.left,e.top),t.stroke(),t.closePath())}return t.prototype.velocityFrom=function(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):1},t.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.radiu=function(){},t.prototype.isInArea=function(t){for(var e=2*Math.PI,i=[],o=0;o<t.length;++o){var n=t[o],s=n.x-this.x,r=n.y-this.y,h=Math.atan2(r,s);h<0?i.push(e+h):i.push(h)}for(var a=0,l=0;l<i.length;++l){var u=i[l],c=l+1;c>=i.length&&(c=0);var p=i[c],d=p-u;l+1>=i.length&&d<-Math.PI&&(d=2*Math.PI+d),a+=d}return Math.abs(a)<.01},e.calculateCurveControlPoints=function(e,i,o){var n=e.x-i.x,s=e.y-i.y,r=i.x-o.x,h=i.y-o.y,a={x:(e.x+i.x)/2,y:(e.y+i.y)/2},l={x:(i.x+o.x)/2,y:(i.y+o.y)/2},u=Math.sqrt(n*n+s*s),c=Math.sqrt(r*r+h*h),p=a.x-l.x,d=a.y-l.y,f=c/(u+c),_={x:l.x+p*f,y:l.y+d*f},v=i.x-_.x,y=i.y-_.y;return{c1:new t(a.x+v,a.y+y),c2:new t(l.x+v,l.y+y)}},e.prototype.length=function(){for(var t=0,e=void 0,i=void 0,o=0;o<=10;o+=1){var n=o/10,s=this._point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),r=this._point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(o>0){var h=s-e,a=r-i;t+=Math.sqrt(h*h+a*a)}e=s,i=r}return t},e.prototype._point=function(t,e,i,o,n){return e*(1-t)*(1-t)*(1-t)+3*i*(1-t)*(1-t)*t+3*o*(1-t)*t*t+n*t*t*t},o.prototype.clear=function(){this.p1=null,this.p2=null,this.top=null,this.bottom=null,this.left=null,this.right=null},o.prototype.isInBound=function(t,e){return t>=this.left&&t<=this.right&&e>=this.top&&e<=this.bottom},o.prototype.isOnVertical=function(t,e){return Math.abs(t-this.left)<=2||Math.abs(t-this.right)<=2},o.prototype.isOnHorizon=function(t,e){return Math.abs(e-this.top)<=2||Math.abs(e-this.bottom)<=2},o.prototype.slopeWith=function(t,e){return Math.abs(this.slope(t,e))<.3},o.prototype.slope=function(t,e){var i=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y;return(t-this.p1.x)/i-(e-this.p1.y)/o},o.prototype.isIntersect=function(t){var e=Math.max(this.left,t.left),i=Math.min(this.right,t.right),o=Math.max(this.top,t.top),n=Math.min(this.bottom,t.bottom);return e-i<0&&o-n<0},o.prototype.merge=function(t){null==this.left&&(this.p1=t.p1,this.p2=t.p2,this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom),this.top=Math.min(this.top,t.top),this.bottom=Math.max(this.bottom,t.bottom),this.left=Math.min(this.left,t.left),this.right=Math.max(this.right,t.right)},n.smooth=function(e,i,o){if(o<=1)return e[0];for(var n=0,s=0,r=0,h=0,a=Math.min(i+o,e.length),l=i;l<a;++l)n+=e[l].x,s+=e[l].y,r+=e[l].pressure,h+=e[l].time;var u=a-i;return new t(n/u,s/u,r/u,h/u)},s.createFragment=function(t,i){var o=t.length-i;if(o>=2){var n=t[i],s=null,r=null,h=null;2==o?(s=t[i],r=t[i+1],h=t[i+1]):3===o?(s=t[i],r=t[i+1],h=t[i+2]):(s=t[i+1],r=t[i+2],h=t[i+3]);var a=e.calculateCurveControlPoints(n,s,r),l=a.c2;a=e.calculateCurveControlPoints(s,r,h);return new e(s,l,a.c1,r)}return null},s.calculateFragmentWidths=function(t,e){var i=t.startPoint,o=t.endPoint,n={start:null,end:null},s=Math.exp(-2*e*(i.pressure-.5)),r=Math.exp(-2*e*(o.pressure-.5));return n.start=2*e/(1+s),n.end=2*e/(1+r),n},s.drawFragment=function(t,e,i,o){var n=o-i,r=Math.floor(e.length());t.beginPath();for(var h=0;h<r;h+=1){var a=h/r,l=a*a,u=l*a,c=1-a,p=c*c,d=p*c,f=d*e.startPoint.x;f+=3*p*a*e.control1.x,f+=3*c*l*e.control2.x,f+=u*e.endPoint.x;var _=d*e.startPoint.y;_+=3*p*a*e.control1.y,_+=3*c*l*e.control2.y,_+=u*e.endPoint.y;var v=i+u*n;v<=.3&&console.info("----"),s.drawPoint(t,f,_,v)}t.closePath(),t.fill()},s.drawPoint=function(t,e,i,o){t.moveTo(e,i),t.arc(e,i,o,0,2*Math.PI,!1)},s.drawDot=function(t,e,i,o){t.beginPath(),s.drawPoint(t,e,i,o),t.closePath(),t.fill()},s.appendPoint=function(t,e,i){null==e.left&&(e.left=i.x,e.right=i.x,e.top=i.y,e.bottom=i.y),t.push(i);var o=i.x,n=i.y;e.right=Math.max(e.right,o,e.left),e.left=Math.min(e.right,o,e.left),e.top=Math.min(e.top,n,e.bottom),e.bottom=Math.max(e.top,n,e.bottom)},s.prototype.addPoint=function(t){s.appendPoint(this.data,this.bbox,t),this.length+=1},s.prototype.last=function(){return 0==this.data.length?null:this.data[this.data.length-1]},s.prototype.get=function(t){return this.data[t]},s.prototype.isIn=function(t,e){return this.bbox.isInBound(t,e)},s.prototype.draw=function(t){if(1!=this.hide){var e=t.fillStyle;t.fillStyle=this.color;for(var i=0;i<4;++i){for(var o=[],n=0;n<=i;++n){var s=n;s>=this._smoothData.length&&(s=this._smoothData.length-1),o.push(this._smoothData[s])}this._drawFrag(t,o,0)}for(var r=0;r<this._smoothData.length;++r)this._drawFrag(t,this._smoothData,r);t.fillStyle=e}},s.prototype._drawFrag=function(t,e,i){if(e.length<2)s.drawDot(t,e[0].x,e[0].y,this.radiu);else{var o=s.createFragment(e,i);if(o){var n=s.calculateFragmentWidths(o,this.radiu);n&&s.drawFragment(t,o,n.start,n.end)}}},r.prototype.clear=function(){var t=this._ctx,e=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(),this._isEmpty=!0},r.prototype.setRadiu=function(t){t>5&&(t=5),t<.01&&(t=1),this.radiu=t||1.5},r.prototype.setState=function(t){this.state=t},r.prototype.fromDataURL=function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=new Image,n=i.ratio||window.devicePixelRatio||1,s=i.width||this._canvas.width/n,r=i.height||this._canvas.height/n;this._reset(),o.src=t,o.onload=function(){e._ctx.drawImage(o,0,0,s,r)},this._isEmpty=!1},r.prototype.toDataURL=function(t){var e;switch(t){case"image/svg+xml":return this._toSVG();default:for(var i=arguments.length,o=Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];return(e=this._canvas).toDataURL.apply(e,[t].concat(o))}},r.prototype.on=function(){this._mouseButtonDown=!1,this._canvas.addEventListener("pointerdown",this._handlePointerDown),this._canvas.addEventListener("pointermove",this._handlePointerMove),this._canvas.addEventListener("pointerup",this._handlePointerUp),this._canvas.addEventListener("lostpointercapture",this._handlePointerLost)},r.prototype.off=function(){this._canvas.removeEventListener("pointerdown",this._handlePointerDown),this._canvas.removeEventListener("pointermove",this._handlePointerMove),this._canvas.removeEventListener("pointerup",this._handlePointerUp)},r.prototype.isEmpty=function(){return this._isEmpty},r.prototype.hitTest=function(t){for(var e=this._data.length,i=[],n=0;n<e;++n)this._data[n].isIn(t.x,t.y)&&i.push(this._data[n]);for(var s=[],r=0;r<i.length;++r)for(var h=i[r],a=h._smoothData,l=0;l<a.length-1;++l){var u=a[l],c=a[l+1],p=new o(u,c);if(null==this._lastPoint)p.isInBound(t.x,t.y)&&p.slopeWith(t.x,t.y)&&s.push(h);else if(p.isIntersect(new o(this._lastPoint,t))){var d=p.slope(this._lastPoint.x,this._lastPoint.y),f=p.slope(t.x,t.y);(d*f<0||Math.abs(d)<.3||Math.abs(f)<.3)&&s.push(h)}p=null}return this._lastPoint=t,s.length>0?s:null},r.prototype.redraw=function(){this._clearBackground(),this.drawCurves(this._data),h(this._ctx,this._bbox)},r.prototype.drawCurve=function(t){this._ctx.beginPath(),this._drawCurve(t),this._ctx.closePath()},r.prototype.drawCurves=function(t){this._ctx.beginPath();for(var e=0;e<t.length;++e)this._drawCurve(t[e]);this._ctx.closePath()},r.prototype._strokeBegin=function(t){if("pen"==this.state){this.maxID+=1;var e=new s(this.maxID,this.penColor);e.radiu=this.radiu,this._data.push(e),this._reset()}if("select"===this.state){var i=this._event2Point(t);if(this._bbox.isInBound(i.x,i.y))return void(this._startMovePt=i);this._bbox.clear(),this._selectCurves.length=0,this._startMovePt=null}this._strokeUpdate(t),"function"==typeof this.onBegin&&this.onBegin(t)},r.prototype._strokeEnd=function(t){switch(this.state){case"pen":var e=this.points.length>2,i=this.points[0];!e&&i&&this._drawDot(i);var n=this._event2Point(t);n.pressure=.005,this._drawAddedPoint(n),this._drawLastPoints();break;case"select":if(null!==this._selectState)return this._startMovePt=null,void console.info("end");for(var s=this._data,r=[],h=0;h<s.length;++h){var a=s[h];if(this._bbox.isIntersect(a.bbox)){for(var l=[],u=0;u<a.length;++u){var c=a._smoothData[u];this._bbox.isInBound(c.x,c.y)&&l.push(c)}l.length>0&&r.push({curve:a,points:l})}}for(var p=new o(null,null),d=0;d<r.length;++d)for(var f=0;f<r[d].points.length;++f){var _=r[d].points[f];if(_.isInArea(this.smoothGroup)){this._selectCurves.push(r[d].curve),p.merge(r[d].curve.bbox);break}}this._bbox=p}"function"==typeof this.onEnd&&this.onEnd(t)},r.prototype._strokeUpdate=function(t){var e=this._event2Point(t);switch(this.state){case"pen":this._drawAddedPoint(e);break;case"eraser":var i=this.hitTest(e);if(null!=i){for(var o=0;o<i.length;++o)i[o].hide=!0;this.redraw()}break;case"select":if(0==this._selectCurves.length){this._drawRing(e);var n=this.smoothGroup;if(n.length&&n[n.length-1].equals(e))break;s.appendPoint(this.smoothGroup,this._bbox,e)}else{if(null===this._startMovePt)return;var r=e.x-this._startMovePt.x,h=e.y-this._startMovePt.y;if(0===r&&0===h)return;switch(this._startMovePt=e,this._selectState){case"move":for(var a=this._selectCurves.length,l=0;l<a;++l){for(var u=this._selectCurves[l],c=u._smoothData,p=0;p<c.length;++p)c[p].x+=r,c[p].y+=h;var d=u.bbox;d.left+=r,d.right+=r,d.top+=h,d.bottom+=h}this._bbox.left+=r,this._bbox.right+=r,this._bbox.top+=h,this._bbox.bottom+=h}this.redraw()}break;default:this.hitTest(e)}},r.prototype._setSelectState=function(t){if(this._selectState!==t){console.info(this._selectState+"        "+t),this._selectState=t;var e=this._canvas;switch(t){case"move":e.style.cursor="move";break;case"h":e.style.cursor="n-resize";break;case"v":e.style.cursor="e-resize";break;default:e.style.cursor="auto"}}},r.prototype._mouseMove=function(t){if("select"===this.state&&!1===this._mouseButtonDown){var e=this._event2Point(t);this._canvas;this._bbox.isInBound(e.x,e.y)?this._bbox.isOnVertical(e.x,e.y)?this._setSelectState("v"):this._bbox.isOnHorizon(e.x,e.y)?this._setSelectState("h"):this._setSelectState("move"):this._setSelectState(null)}},r.prototype._clearBackground=function(){var t=this._ctx,e=this._canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height)},r.prototype._drawCurve=function(t){t.draw(this._ctx)},r.prototype._addSmoothPoint=function(t){this.smoothGroup.push(t),this._data[this._data.length-1]._smoothData.push(t)},r.prototype._smoothTo=function(t){var e=this.points,i=e.length,o=this._data[this._data.length-1];if(t){if(i>0){var s=e[i-1];if(t.equals(s))return}if(o.addPoint(t),e.push(t),i<2)return void(0==this.smoothGroup.length&&this._addSmoothPoint(e[0]));var r=Math.max(i-5,0),h=n.smooth(e,r,r>0?5:3);this._addSmoothPoint(h)}else if(i<2)this._addSmoothPoint(e[i-1]);else if(i>2){var a=n.smooth(e,i-3,3);this._addSmoothPoint(a),this._addSmoothPoint(e[i-1])}},r.prototype._event2Point=function(t){var e=t.clientX,i=t.clientY;return t.pressure&&(this.pressure=t.pressure),this._createPoint(e,i,this.pressure)},r.prototype._drawAddedPoint=function(t){var e=this._addPoint(t);e?this._calculateWidthAndDraw(e):0==this.points.length&&this._drawDot(t)},r.prototype._calculateWidthAndDraw=function(t){var e=s.calculateFragmentWidths(t,this.radiu);e?s.drawFragment(this._ctx,t,e.start,e.end):console.info("width")},r.prototype._drawLastPoints=function(){var t=this._addPoint();t&&(this._calculateWidthAndDraw(t),this._drawEndCurve())},r.prototype._drawEndCurve=function(){var t=this._caculateCurve(this.smoothGroup);if(t){this._calculateWidthAndDraw(t);var e=this.smoothGroup[this.smoothGroup.length-1];t.endPoint.equals(e)||(e.pressure=.005,this.smoothGroup.push(e),this._drawEndCurve())}else console.info("null")},r.prototype._reset=function(){this.points=[],this.smoothGroup=[],this._lastPoint=null,this._lastVelocity=0,this._lastWidth=this.radiu,this._bbox.clear(),this._startMovePt=null,this._ctx.fillStyle=this.penColor},r.prototype._createPoint=function(e,i,o,n){var s=this._canvas.getBoundingClientRect();return new t(e-s.left,i-s.top,o,n||(new Date).getTime())},r.prototype._caculateCurve=function(t){if(t.length>2){3===t.length&&t.unshift(t[0]);var e=s.createFragment(t,0);return t.shift(),e}return null},r.prototype._addPoint=function(t){return this._smoothTo(t),this._caculateCurve(this.smoothGroup)},r.prototype._drawDot=function(t){var e=this._ctx,i="function"==typeof this.dotSize?this.dotSize():this.dotSize;this._isEmpty=!1,s.drawDot(e,t.x,t.y,i)},r.prototype._drawRing=function(t){var e=this._ctx,i=e.fillStyle;e.fillStyle="black",e.beginPath(),e.arc(t.x,t.y,3,0,2*Math.PI),e.closePath(),e.stroke(),e.fillStyle=i},r.prototype._fromData=function(t,e,i){for(var o=0;o<t.length;o+=1){var n=t[o];if(n.length>1)for(var r=0;r<n.length;r+=1){var h=n.get(r),a=n.color;if(0===r)this._reset(),this._addPoint(h);else if(r!==n.length-1){var l=this._addPoint(h);if(l){var u=s.calculateFragmentWidths(l,this.radiu);u&&e(l,u,a)}}}else{this._reset();i(n.get(0))}}},r.prototype._toSVG=function(){var t=this,e=this._data,i=this._canvas,o=Math.max(window.devicePixelRatio||1,1),n=i.width/o,s=i.height/o,r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS(null,"width",i.width),r.setAttributeNS(null,"height",i.height),this._fromData(e,function(t,e,i){var o=document.createElement("path");if(!(isNaN(t.control1.x)||isNaN(t.control1.y)||isNaN(t.control2.x)||isNaN(t.control2.y))){var n="M "+t.startPoint.x.toFixed(3)+","+t.startPoint.y.toFixed(3)+" C "+t.control1.x.toFixed(3)+","+t.control1.y.toFixed(3)+" "+t.control2.x.toFixed(3)+","+t.control2.y.toFixed(3)+" "+t.endPoint.x.toFixed(3)+","+t.endPoint.y.toFixed(3);o.setAttribute("d",n),o.setAttribute("stroke-width",(2.25*e.end).toFixed(3)),o.setAttribute("stroke",i),o.setAttribute("fill","none"),o.setAttribute("stroke-linecap","round"),r.appendChild(o)}},function(e){var i=document.createElement("circle"),o="function"==typeof t.dotSize?t.dotSize():t.dotSize;i.setAttribute("r",o),i.setAttribute("cx",e.x),i.setAttribute("cy",e.y),i.setAttribute("fill",e.color),r.appendChild(i)});var h='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 '+n+" "+s+'" width="'+n+'" height="'+s+'">',a=r.innerHTML;if(void 0===a){var l=document.createElement("dummy"),u=r.childNodes;l.innerHTML="";for(var c=0;c<u.length;c+=1)l.appendChild(u[c].cloneNode(!0));a=l.innerHTML}var p=h+a+"</svg>";return"data:image/svg+xml;base64,"+btoa(p)},r.prototype.fromData=function(t){var e=this;this.clear(),this._fromData(t,function(t,i){return s.drawFragment(e._ctx,t,i.start,i.end)},function(t){return e._drawDot(t)}),this._data=t},r.prototype.toData=function(){return this._data},r});
